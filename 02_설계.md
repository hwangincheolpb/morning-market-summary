# 설계

## 아키텍처 개요

아침 시황 요약 자동화 시스템은 다음과 같은 구성요소로 이루어집니다:

1. **시황 데이터 수집 모듈**: 다양한 소스에서 금융 데이터 수집
2. **Gemini 요약 모듈**: Gemini API/인터페이스를 통한 요약 생성
3. **엑셀 관리 모듈**: 수신자 목록, 설정, 이력 관리
4. **발송 모듈**: 문자 및 카카오톡 발송
5. **스케줄링 모듈**: 자동 실행 관리

## 기술 스택

### 사용 기술

#### Microsoft Excel
- **Excel 2016 이상**: 메인 관리 플랫폼
- **VBA (Visual Basic for Applications)**: 메인 스크립팅 언어
- **Power Query**: 데이터 수집 및 변환 (선택)

#### 데이터 수집
- **HTTP 요청**: WinHttp, MSXML2
- **웹 스크래핑**: Selenium (필요시), BeautifulSoup (Python 연동 시)
- **REST API**: 시황 데이터 API 호출

#### AI 요약
- **Gemini API**: Google Gemini API 직접 호출
- **또는 Selenium**: Gemini 웹 인터페이스 자동화
- **JSON 파서**: VBA-JSON 또는 직접 파싱

#### 발송 서비스
- **알리고 API**: SMS 발송
- **카카오톡 비즈니스 API**: 카카오톡 발송
- **기타 SMS API**: 나이스정보통신, 쿨SMS 등

#### 스케줄링
- **Windows Task Scheduler**: 자동 실행
- **또는 Application.OnTime**: 엑셀 내부 스케줄링

### 선택 이유

**Excel + VBA 선택:**
- 사용자에게 친숙한 인터페이스
- 수신자 목록 관리 용이
- 추가 설치 불필요
- Windows 환경에서 강력한 기능

**Gemini API 선택:**
- 안정적인 자동화
- 빠른 응답 시간
- 일관된 결과

**알리고/카카오톡 API 선택:**
- 국내 주요 발송 서비스
- 안정적인 API 제공
- 다양한 발송 옵션

## 시스템 구조

```
┌─────────────────────────────────┐
│   Windows Task Scheduler        │
│   (매일 아침 7시 실행)          │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│      엑셀 통합 문서              │
│  ┌──────────┬────────────────┐  │
│  │ 설정 시트│  수신자 목록    │  │
│  │          │  시트          │  │
│  └──────────┴────────────────┘  │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│      VBA 메인 모듈               │
│  ┌──────────┬────────────────┐  │
│  │ 스케줄러 │  워크플로우    │  │
│  │          │  관리자        │  │
│  └──────────┴────────────────┘  │
└──────────────┬──────────────────┘
               │
       ┌───────┴───────┐
       │               │
       ▼               ▼
┌─────────────┐  ┌─────────────┐
│ 시황 데이터 │  │ Gemini      │
│ 수집 모듈   │  │ 요약 모듈   │
└─────────────┘  └─────────────┘
       │               │
       └───────┬───────┘
               │
               ▼
┌─────────────────────────────────┐
│      요약 결과 생성              │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│      발송 모듈                   │
│  ┌──────────┬────────────────┐  │
│  │ SMS      │  카카오톡      │  │
│  │ 발송     │  발송          │  │
│  └──────────┴────────────────┘  │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│      발송 이력 기록              │
│      (엑셀 시트)                 │
└─────────────────────────────────┘
```

## 주요 컴포넌트

### 1. 엑셀 통합 문서 구조

**역할:**
- 설정 관리
- 수신자 목록 관리
- 발송 이력 기록
- 수동 실행 인터페이스

**시트 구성:**
- **설정 시트**: API 키, 발송 시간, 데이터 소스 설정
- **수신자 목록 시트**: 이름, 전화번호, 발송 채널, 그룹
- **발송 이력 시트**: 발송 날짜, 시간, 수신자, 상태, 요약 내용
- **시황 데이터 시트**: 수집된 원본 데이터 (선택)
- **요약 결과 시트**: 생성된 요약 내용 (선택)

**수신자 목록 구조:**
| 컬럼 | 설명 |
|------|------|
| 이름 | 수신자 이름 |
| 전화번호 | 발송할 전화번호 |
| 발송채널 | SMS / 카톡 / 둘다 |
| 그룹 | 수신자 그룹 (선택) |
| 활성화 | 발송 여부 (Y/N) |
| 마지막발송일 | 마지막 발송 날짜 |

### 2. 시황 데이터 수집 모듈

**역할:**
- 다양한 소스에서 시황 데이터 수집
- 데이터 정제 및 표준화
- 에러 처리 및 재시도

**수집 대상:**
- 주식 지수 (KOSPI, KOSDAQ, 나스닥 등)
- 환율 (USD/KRW, EUR/KRW 등)
- 금리 (한국 기준금리, 미국 금리)
- 원자재 (금, 유가 등)

**구현 방법:**
- REST API 호출 (WinHttp)
- JSON/XML 응답 파싱
- 또는 웹 스크래핑 (Selenium)

**입력:**
- 데이터 소스 설정
- 수집할 항목 목록

**출력:**
- 표준화된 시황 데이터 구조

### 3. Gemini 요약 모듈

**역할:**
- 수집된 시황 데이터를 Gemini에 전달
- 요약 요청 및 결과 수신
- 요약 형식 커스터마이징

**구현 방법 옵션:**

#### 옵션 1: Gemini API 직접 호출
```vba
' Gemini API 호출
Function GetGeminiSummary(marketData As String) As String
    Dim http As Object
    Dim url As String
    Dim requestBody As String
    Dim response As String
    
    url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=YOUR_API_KEY"
    
    requestBody = "{""contents"":[{""parts"":[{""text"":""" & marketData & """}]}]}"
    
    ' HTTP POST 요청
    ' ...
End Function
```

#### 옵션 2: Selenium을 통한 웹 자동화
- Gemini 웹 인터페이스 접근
- 데이터 입력 및 요약 요청
- 결과 추출

**입력:**
- 시황 데이터 (텍스트 또는 구조화된 데이터)
- 요약 프롬프트 템플릿

**출력:**
- 요약된 텍스트

### 4. 발송 모듈

#### 4.1 SMS 발송 (알리고 API)

**역할:**
- 알리고 API를 통한 SMS 발송
- 발송 결과 확인

**구현:**
```vba
Function SendSMS_Aligo(phoneNumber As String, message As String) As Boolean
    Dim http As Object
    Dim url As String
    Dim postData As String
    
    url = "https://apis.aligo.in/send/"
    
    postData = "key=YOUR_API_KEY&user_id=YOUR_USER_ID&sender=발신번호&receiver=" & phoneNumber & "&msg=" & message
    
    ' HTTP POST 요청
    ' ...
End Function
```

#### 4.2 카카오톡 발송 (카카오톡 비즈니스)

**역할:**
- 카카오톡 비즈니스 API를 통한 메시지 발송
- 알림톡/친구톡 발송

**구현:**
```vba
Function SendKakaoTalk(phoneNumber As String, message As String, templateCode As String) As Boolean
    Dim http As Object
    Dim url As String
    Dim jsonData As String
    
    url = "https://kapi.kakao.com/v1/api/talk/friends/message/send"
    
    jsonData = "{""receiver_uuids"":[""" & phoneNumber & """],""template_object"":{""object_type"":""text"",""text"":""" & message & """}}"
    
    ' HTTP POST 요청 (OAuth 토큰 필요)
    ' ...
End Function
```

### 5. 스케줄링 모듈

**역할:**
- 지정된 시간에 자동 실행
- Windows Task Scheduler 연동
- 또는 엑셀 내부 스케줄링

**구현 방법:**

#### 옵션 1: Windows Task Scheduler
- VBS 스크립트 생성
- Task Scheduler에 등록
- 매일 지정 시간에 엑셀 매크로 실행

#### 옵션 2: Application.OnTime
```vba
Sub ScheduleNextRun()
    Dim nextRunTime As Date
    nextRunTime = Date + TimeValue("07:00:00")
    
    If Time < TimeValue("07:00:00") Then
        Application.OnTime nextRunTime, "RunMorningReport"
    Else
        ' 다음날로
        nextRunTime = Date + 1 + TimeValue("07:00:00")
        Application.OnTime nextRunTime, "RunMorningReport"
    End If
End Sub
```

### 6. 워크플로우 관리자

**역할:**
- 전체 프로세스 조율
- 에러 처리 및 재시도
- 로깅 및 이력 관리

**주요 함수:**
```vba
Sub RunMorningReport()
    On Error GoTo ErrorHandler
    
    ' 1. 시황 데이터 수집
    Dim marketData As String
    marketData = CollectMarketData()
    
    ' 2. Gemini 요약 생성
    Dim summary As String
    summary = GetGeminiSummary(marketData)
    
    ' 3. 수신자 목록 읽기
    Dim recipients As Collection
    Set recipients = GetRecipients()
    
    ' 4. 발송
    Dim recipient As Variant
    For Each recipient In recipients
        Call SendMessage(recipient, summary)
    Next
    
    ' 5. 이력 기록
    Call LogHistory(summary, recipients)
    
    Exit Sub
    
ErrorHandler:
    Call LogError(Err.Description)
    ' 알림 발송
End Sub
```

## 데이터 흐름

1. **스케줄러 트리거**
   - Windows Task Scheduler 또는 Application.OnTime
   - 엑셀 파일 열기 및 매크로 실행

2. **시황 데이터 수집**
   - 설정 시트에서 데이터 소스 읽기
   - 각 소스에서 데이터 수집
   - 데이터 정제 및 통합

3. **Gemini 요약 생성**
   - 수집된 데이터를 텍스트로 변환
   - Gemini API에 요청
   - 요약 결과 수신

4. **수신자 목록 읽기**
   - 수신자 목록 시트에서 활성화된 수신자 읽기
   - 발송 채널 확인

5. **메시지 발송**
   - 각 수신자별로 발송 채널에 맞게 발송
   - 발송 결과 확인

6. **이력 기록**
   - 발송 이력 시트에 기록
   - 요약 내용 저장
   - 통계 업데이트

## 보안 고려사항

### API 키 관리
- API 키를 암호화하여 저장
- 설정 시트 보호 및 숨김
- 환경 변수 활용 (가능한 경우)

### 개인정보 보호
- 수신자 정보 보호
- 발송 이력 안전하게 관리
- 엑셀 파일 자체 보호

### 네트워크 보안
- HTTPS 통신 사용
- 인증서 검증
- 안전한 API 호출

## 확장성 고려사항

### 추가 데이터 소스
- 새로운 시황 데이터 소스 쉽게 추가
- 어댑터 패턴 활용

### 추가 발송 채널
- 이메일 발송
- 슬랙 메시지
- 텔레그램 메시지

### 고급 기능
- 개인화된 메시지
- 다국어 지원
- 다양한 요약 형식
- 시각화 포함 메시지

## 대안 설계

### 옵션 1: Python 스크립트 + 엑셀
- Python으로 데이터 수집 및 발송
- 엑셀은 수신자 관리만
- 더 강력한 라이브러리 활용 가능

### 옵션 2: 완전 자동화 (엑셀 없음)
- 독립 실행형 애플리케이션
- 데이터베이스 기반 관리
- 웹 인터페이스 제공

### 옵션 3: 클라우드 기반
- AWS Lambda 또는 Google Cloud Functions
- 완전 자동화
- 스케줄링 내장
