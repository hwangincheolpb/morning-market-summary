"""
Gemini APIë¥¼ ì‚¬ìš©í•œ ì‹œí™© ìš”ì•½ ëª¨ë“ˆ
"""

import google.generativeai as genai
from typing import Optional


class GeminiSummarizer:
    """Gemini APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹œí™© ìš”ì•½ ìƒì„±"""
    
    def __init__(self, api_key: str, use_detailed: bool = False):
        genai.configure(api_key=api_key)
        self.model = genai.GenerativeModel('gemini-pro')
        self.use_detailed = use_detailed
        self.prompt_template = self._get_prompt_template()
    
    def _get_prompt_template(self) -> str:
        """í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ë°˜í™˜"""
        if self.use_detailed:
            # ìƒì„¸ ë²„ì „ í”„ë¡¬í”„íŠ¸
            return """ë‹¹ì‹ ì€ ì‹ í•œíˆ¬ìì¦ê¶Œ ì„œìš¸ê¸ˆìœµì„¼í„° í™©ì¸ì²  PBì˜ 'ì „ìš© ì‹œí™© ë¹„ì„œ'ì…ë‹ˆë‹¤.

ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë‰´ìŠ¤(í…ìŠ¤íŠ¸/ë§í¬)ë¥¼ ë¶„ì„í•˜ì—¬, ì¦‰ì‹œ 'ê³ ê° ë°œì†¡ìš© ë©”ì‹œì§€'ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. ì‚¬ë‹´ì´ë‚˜ ë¶„ì„ ì½”ë©˜íŠ¸ëŠ” í•˜ì§€ ì•Šê³  ê²°ê³¼ë¬¼ë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.

[ì‘ì„± ì›ì¹™]
1. ì˜ì–´ ìš”ì•½ì´ë‚˜ ì‚¬ì¡± ì—†ì´, ì˜¤ì§ 'ê²°ê³¼ë¬¼(í•œê¸€ ë©”ì‹œì§€)'ë§Œ ì¶œë ¥í•œë‹¤.
2. ì•„ë˜ ì§€ì •ëœ í‘œì¤€ ì–‘ì‹ì„ í† ì”¨ í•˜ë‚˜ í‹€ë¦¬ì§€ ì•Šê³  ì¤€ìˆ˜í•œë‹¤.
3. ì´ëª¨ì§€ì™€ ê°€ë…ì„±ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•œë‹¤.
4. ê·¸ë•Œê·¸ë•Œ ì¤‘ìš”í•œ ì§€í‘œëŠ” ì¶”ê°€í•´ë„ ë¨.

[í‘œì¤€ ì¶œë ¥ ì–‘ì‹]

ì‹ í•œíˆ¬ìì¦ê¶Œ ì„œìš¸ê¸ˆìœµì„¼í„° í™©ì¸ì² PBì…ë‹ˆë‹¤.

[  ]

ğŸ‡ºğŸ‡¸ **[ë‚ ì§œ] ë¯¸êµ­ ì¦ì‹œ: [í•µì‹¬ í‚¤ì›Œë“œ 1~2ê°œ]**

 ìƒë‹¨ 3ì¤„ ìš”ì•½: ë³¸ë¬¸ ì‹œì‘ ì „, í•µì‹¬ ì´ìŠˆ 3ê°€ì§€ë¥¼ '-'ê¸°í˜¸ì™€ í•¨ê»˜ í•œ ë¬¸ì¥ì”© ì •ë¦¬í•œë‹¤.

[  ]

- [í•µì‹¬ ì´ìŠˆ ìš”ì•½ 1]

- [í•µì‹¬ ì´ìŠˆ ìš”ì•½ 2]

- [í•µì‹¬ ì´ìŠˆ ìš”ì•½ 3]

[  ]

âœ… í•µì‹¬ ë‚´ìš©

[  ]

ì‹œì¥ ì´í‰: (ìƒìŠ¹/í•˜ë½ ì›ì¸, ë°°ê²½, ì‹œì¥ ë¶„ìœ„ê¸°)

ì£¼ìš” ì¢…ëª©: (íŠ¹ì§•ì£¼, ì£¼ë„ ì„¹í„°, ë“±ë½í­ì´ í° ì¢…ëª© ìœ„ì£¼)

íˆ¬ì ì‹¬ë¦¬: (ë§¤í¬ë¡œ ì§€í‘œ ë³€í™”ê°€ íˆ¬ì ì‹¬ë¦¬ì— ë¯¸ì¹œ ì˜í–¥)

[  ]

ğŸ“Š ì£¼ìš” ì§€ìˆ˜

[  ]

ë‹¤ìš° [ì§€ìˆ˜] ([ë“±ë½ë¥ ])

ë‚˜ìŠ¤ë‹¥ [ì§€ìˆ˜] ([ë“±ë½ë¥ ])

S&P 500 [ì§€ìˆ˜] ([ë“±ë½ë¥ ])

MSCI í•œêµ­ [ë“±ë½ë¥ ]

[  ]

ğŸ“‰ ë§¤í¬ë¡œ ì§€í‘œ

[  ]

ë‹¬ëŸ¬ì¸ë±ìŠ¤: [ìˆ˜ì¹˜] ([ë“±ë½ë¥ ])

êµ­ì œìœ ê°€: [ìˆ˜ì¹˜] ([ë“±ë½ë¥ ])

10ë…„ë¬¼ ê¸ˆë¦¬: [ìˆ˜ì¹˜]

ë³€ë™ì„±(VIX): [ìˆ˜ì¹˜] ([ë“±ë½ë¥ ])

[  ]

 * [ì„¤ëª… í‚¤ì›Œë“œ]ì´ë€? [ìƒì„¸ ì„¤ëª… ë‚´ìš©]

 

ê°ì‚¬í•©ë‹ˆë‹¤.

ì•„ë˜ ì‹œí™© ë°ì´í„°ë¥¼ ìœ„ ì–‘ì‹ì— ë§ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”:
"""
        else:
            # ê°„ê²° ë²„ì „ í”„ë¡¬í”„íŠ¸
            return """ë‹¹ì‹ ì€ ì‹ í•œíˆ¬ìì¦ê¶Œ ì„œìš¸ê¸ˆìœµì„¼í„° í™©ì¸ì²  PBì˜ 'ì „ìš© ì‹œí™© ë¹„ì„œ'ì…ë‹ˆë‹¤.

ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì‹œí™© ë‰´ìŠ¤ë¥¼ ë¶„ì„í•˜ì—¬, ì¦‰ì‹œ 'ê³ ê° ë°œì†¡ìš© ë©”ì‹œì§€'ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. ì‚¬ë‹´ì´ë‚˜ ë¶„ì„ ì½”ë©˜íŠ¸ëŠ” í•˜ì§€ ì•Šê³  ê²°ê³¼ë¬¼ë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.

[ì‘ì„± ì›ì¹™]
1. ì˜ì–´ ìš”ì•½ì´ë‚˜ ì‚¬ì¡± ì—†ì´, ì˜¤ì§ 'ê²°ê³¼ë¬¼(í•œê¸€ ë©”ì‹œì§€)'ë§Œ ì¶œë ¥í•œë‹¤.
2. ì•„ë˜ ì§€ì •ëœ ì–‘ì‹ì„ ì •í™•íˆ ì¤€ìˆ˜í•œë‹¤.
3. ì´ëª¨ì§€ì™€ ê°€ë…ì„±ì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•œë‹¤.

[í‘œì¤€ ì¶œë ¥ ì–‘ì‹]

ì‹ í•œíˆ¬ìì¦ê¶Œ ì„œìš¸ê¸ˆìœµì„¼í„° í™©ì¸ì² PBì…ë‹ˆë‹¤.

ğŸ‡ºğŸ‡¸ [ë‚ ì§œ] ë¯¸êµ­ ì¦ì‹œ: [í•µì‹¬ í‚¤ì›Œë“œ 1~2ê°œ]

âœ… í•µì‹¬ ìš”ì•½

 * [í•µì‹¬ ìš”ì•½ 1]
 * [í•µì‹¬ ìš”ì•½ 2]
 * [í•µì‹¬ ìš”ì•½ 3]

ğŸ“Š ì£¼ìš” ì§€ìˆ˜

ë‹¤ìš° [ì§€ìˆ˜] ([ë“±ë½ë¥ ])
ë‚˜ìŠ¤ë‹¥ [ì§€ìˆ˜] ([ë“±ë½ë¥ ])
S&P 500 [ì§€ìˆ˜] ([ë“±ë½ë¥ ])
MSCI í•œêµ­ [ë“±ë½ë¥ ]

ğŸ“‰ ë§¤í¬ë¡œ ì§€í‘œ

 * ë‹¬ëŸ¬ì¸ë±ìŠ¤: [ìˆ˜ì¹˜] ([ë“±ë½ë¥ ])
 * êµ­ì œìœ ê°€: [ìˆ˜ì¹˜] ([ë“±ë½ë¥ ])
 * 10ë…„ë¬¼ ê¸ˆë¦¬: [ìˆ˜ì¹˜]
 * ë³€ë™ì„±(VIX): [ìˆ˜ì¹˜] ([ë“±ë½ë¥ ])

ê°ì‚¬í•©ë‹ˆë‹¤.

ì•„ë˜ ì‹œí™© ë°ì´í„°ë¥¼ ìœ„ ì–‘ì‹ì— ë§ê²Œ ìš”ì•½í•´ì£¼ì„¸ìš”:
"""
    
    def summarize(self, market_data: str, max_retries: int = 3) -> Optional[str]:
        """
        ì‹œí™© ë°ì´í„°ë¥¼ ìš”ì•½í•˜ì—¬ ë°˜í™˜

        Args:
            market_data: ìš”ì•½í•  ì‹œí™© ë°ì´í„°
            max_retries: ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜

        Returns:
            ìš”ì•½ëœ í…ìŠ¤íŠ¸ ë˜ëŠ” None
        """
        import time

        for attempt in range(max_retries):
            try:
                full_prompt = self.prompt_template + "\n\n" + market_data

                response = self.model.generate_content(full_prompt)

                if response.text:
                    summary = response.text.strip()

                    # ê¸°ë³¸ ê²€ì¦: ìš”ì•½ì´ ë„ˆë¬´ ì§§ìœ¼ë©´ ì‹¤íŒ¨ë¡œ ê°„ì£¼
                    if len(summary) < 100:
                        print(f"âš ï¸ ìš”ì•½ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤ ({len(summary)}ì). ì¬ì‹œë„ ì¤‘... ({attempt + 1}/{max_retries})")
                        if attempt < max_retries - 1:
                            time.sleep(2)
                            continue

                    return summary
                else:
                    print(f"âš ï¸ Gemini API ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ì¬ì‹œë„ ì¤‘... ({attempt + 1}/{max_retries})")

            except Exception as e:
                print(f"âŒ Gemini ìš”ì•½ ì˜¤ë¥˜ (ì‹œë„ {attempt + 1}/{max_retries}): {e}")

            # ì¬ì‹œë„ ì „ ëŒ€ê¸°
            if attempt < max_retries - 1:
                wait_time = 2 ** attempt  # ì§€ìˆ˜ ë°±ì˜¤í”„: 1ì´ˆ, 2ì´ˆ, 4ì´ˆ
                print(f"â³ {wait_time}ì´ˆ í›„ ì¬ì‹œë„...")
                time.sleep(wait_time)

        print("âŒ ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. ìš”ì•½ ìƒì„± ì‹¤íŒ¨.")
        return None
